<?php

namespace AppBundle\Repository;

use AppBundle\Entity\Genre;
use AppBundle\Entity\Movie;
use AppBundle\Entity\Torrent;
use DateTime;
use Doctrine\ORM\Query;
use Doctrine\ORM\Tools\Pagination\Paginator;

/**
 * MovieRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class MovieRepository extends \Doctrine\ORM\EntityRepository
{
    /**
     * @param int $limit
     * @return mixed
     */
    public function findLatest(int $limit = 10) {
        return $this->createQueryBuilder('m')
            ->setMaxResults($limit)
            ->orderBy('m.createdAt', 'DESC')
            ->getQuery()
            ->execute();
    }

    /**
     * @param int $limit
     * @return mixed
     */
    public function findPopular(int $limit = 10) {
        return $this->createQueryBuilder('m')
            ->orderBy('m.downloaded', 'DESC')
            ->getQuery()
            ->execute();
    }

    /**
     * @param array $years
     * @param int|null $currentPage
     * @param int|null $limit
     * @return Paginator
     */
    public function findManyByYears(array $years, int $currentPage = 1, int $limit = 20): Paginator {
        $qb = $this->createQueryBuilder('m');

        foreach ($years as $index => $year) {
            $statement = 'm.releaseDate BETWEEN :from' . $index . ' AND :to' . $index;

            $from = DateTime::createFromFormat('Y-m-d', $year . '-01-01');
            $to = DateTime::createFromFormat('Y-m-d', (int)$year + 1 . '-01-01');

            if ($index == 0) {
                $qb->where($statement);
            } else {
                $qb->orWhere($statement);
            }

            $qb->setParameter('from' . $index, $from->format('Y-m-d'));
            $qb->setParameter('to' . $index, $to->format('Y-m-d'));
        }

        return $this->paginate($qb->getQuery(), $currentPage, $limit);
    }

    /**
     *
     * @param array $genres
     * @param int $currentPage
     * @param int $limit
     * @return Paginator
     */
    public function findManyByGenres(array $genres, int $currentPage = 1, int $limit = 20): Paginator {
        $qb = $this->createQueryBuilder('m');
        $qb->innerJoin('m.genres', 'g');

        $qb->where('g.name IN (:genreNames)')
            ->groupBy('m.id')
            ->having('count(g.name) = ' . count($genres))
            ->setParameter('genreNames', $genres);

        return $this->paginate($qb->getQuery(), $currentPage, $limit);
    }

    /**
     * @param int $currentPage
     * @param int $limit
     * @return Paginator
     */
    public function findRecent(int $currentPage = 1, int $limit = 20): Paginator {
        $qb = $this->createQueryBuilder('m');
        $qb->orderBy('m.createdAt');

        return $this->paginate($qb->getQuery(), $currentPage, $limit);
    }

    /**
     * @param Torrent $torrent
     * @return Movie
     * @throws \Doctrine\ORM\NoResultException
     * @throws \Doctrine\ORM\NonUniqueResultException
     */
    public function findByTorrent(Torrent $torrent): Movie {
        return $this->createQueryBuilder('m')
            ->innerJoin('m.torrents', 't', 'WITH', 't.id = :torrentId')
            ->setParameter('torrentId', $torrent->getId())
            ->getQuery()
            ->getSingleResult();
    }

    /**
     * Make movie->downloaded++
     *
     * @param Movie $movie
     * @throws \Doctrine\ORM\OptimisticLockException
     */
    public function downloadCountIterate(Movie $movie): void {
        $em = $this->getEntityManager();
        $movie->setDownloaded($movie->getDownloaded() + 1);
        $em->flush();
    }

    /**
     * @param Query $query
     * @param int $page
     * @param int $limit
     * @return Paginator
     */
    private function paginate(Query $query, int $page, int $limit): Paginator {
        $paginator = new Paginator($query);
        $paginator->getQuery()
            ->setFirstResult($limit * ($page - 1))
            ->setMaxResults($limit);

        return $paginator;
    }
}